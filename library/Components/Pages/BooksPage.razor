@page "/books"
@inject LibraryContext Db
@rendermode InteractiveServer
@inject library.Services.DatabaseService DbService

<PageTitle>Przeszukiwanie książek</PageTitle>

@code {
	private string TitleFilter = "";
	private string AuthorFilter = "";

	public Book selectedBook = new Book();
	public Book newBook = new Book();

	private Category RootCategory = new Category();
	private int Id = 5;

	protected override void OnInitialized()
	{
		RootCategory.Id_category = null;
	}
	async private void onAddEntry()
	{
		Console.WriteLine("Add pressed");
		newBook.Id = Id;
		Id++;
		newBook.Title = "TestTitle";
		newBook.Id_category = "005";
		try
		{
			await DbService.SaveDataAsync(newBook);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error: {ex.Message}");
		}
		UpdateState();
	}

	public void UpdateState()
	{
		StateHasChanged();
	}
	private void onTitleFilter(ChangeEventArgs e)
	{
		TitleFilter = (e.Value ?? "").ToString() ?? "";
	}

	private void onAuthorFilter(ChangeEventArgs e)
	{
		AuthorFilter = (e.Value ?? "").ToString() ?? "";
	}

}

@* MAIN PAGE *@
<div class="container">
	<div class="row">
		<div class="col-md-2">
			Wyszukiwanie
			<input style="margin:10px" @oninput=@onTitleFilter type="text" class="form-control" id="TitleInput"
				placeholder="Tytuł">
			<input style="margin:10px" @oninput=@onAuthorFilter type="text" class="form-control" id="AutorInput"
				placeholder="Autor">
			<input style="margin:10px" type="text" class="form-control" id="PublisherInput" placeholder="Wydawnictwo">

			<div class="dropdown" style="margin:10px;">
				<button class="form-control" type="button" id="dropdownMenuCategory" data-bs-toggle="dropdown"
					aria-expanded="false" data-bs-auto-close="outside">
					Kategoria
				</button>
				<ul class="dropdown-menu" aria-labelledby="dropdownMenuCategory">
					@foreach (var supercategory in Db.Categories.Where(Category => Category.Id_supercategory == null))
					{
						<CategoryComponent Category="@supercategory" />
					}
				</ul>
			</div>


			Zarządzanie
			<button style="margin:10px" type="button" class="btn btn-primary" data-bs-toggle="modal"
				data-bs-target="#AddBookModal">
				Dodaj książkę
			</button>
			<button style="margin:10px" type="button" class="btn btn-primary" data-bs-toggle="modal"
				data-bs-target="#AddCopyModal">
				Dodaj egzemplarz
			</button>
			<button style="margin:10px" type="button" class="btn btn-primary" id="test" @onclick="onAddEntry">
				Test</button>
		</div>
		<div class="col-md-10">
			Dane
			<div class="row-md-6">
				<ul class="list-group overflow-auto shadow" id="BooksList" style="margin:10px; height: 40vh">
					@* <li class="list-group-item"> ==== Database data below ==== </li>
					<li class="list-group-item"></li>
					@foreach (var book in Db.Books.ToList())
					{
						<BookComponent Title="@book.Title" Category="Test Category" />
					}
					<li class="list-group-item"></li> *@
					<li class="list-group-item"> ==== Filtered database data below ==== </li>
					<li class="list-group-item"></li>
					@foreach (var book in Db.Books.Where(book => ((book.Title ?? "").Contains(TitleFilter)) &&
										//TODO: filtering by author and category
										(true)).ToList())
					{
						<CascadingValue Value="this">
							<BookComponent Book="@book" />
						</CascadingValue>
					}
				</ul>
			</div>
			<div class="row-md-6">
				<ul class="list-group overflow-auto shadow" id="CopiesList" style="margin:10px; height: 40vh">
					<li class="list-group-item">
						<h3 style="font-weight: bold;">@selectedBook.Title</h3>
					</li>
					@foreach (var copy in Db.Copies.Where(copy => copy.Id_book == selectedBook.Id).ToList())
					{
						<CascadingValue Value="this">
							<CopyComponent Copy="@copy" />
						</CascadingValue>
					}
				</ul>
			</div>
		</div>
	</div>
</div>

@* ADD COPY MODAL *@
<div class="modal fade" id="AddCopyModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="exampleModalLabel">Dodaj Egzemplarz</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				@* <Counter IncrementAmount="10" /> *@
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary">Save changes</button>
			</div>
		</div>
	</div>
</div>


@* ADD BOOK MODAL *@
<div class="modal fade" id="AddBookModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="exampleModalLabel">Dodaj Egzemplarz</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				@* <Counter IncrementAmount="10" /> *@
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary">Save changes</button>
			</div>
		</div>
	</div>
</div>
